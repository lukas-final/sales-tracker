generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  role      Role     @default(CLOSER)
  createdAt DateTime @default(now())
  
  appointments Appointment[]
  deals        Deal[]
  
  // Stats für Admin-Dashboard
  totalCalls    Int     @default(0)
  totalWins     Int     @default(0)
  totalRevenue  Decimal @db.Decimal(12, 2) @default(0)
  
  @@map("users")
}

model Campaign {
  id          String   @id @default(cuid())
  facebookId  String?  @unique
  name        String
  budget      Decimal  @db.Decimal(10, 2)
  status      CampaignStatus @default(ACTIVE)
  startDate   DateTime
  endDate     DateTime?
  createdAt   DateTime @default(now())
  
  leads       Lead[]
  
  @@map("campaigns")
}

model Lead {
  id          String   @id @default(cuid())
  facebookId  String?
  firstName   String
  lastName    String
  email       String?
  phone       String
  campaignId  String
  source      String   @default("facebook") // facebook, manual, website, etc.
  cost        Decimal? @db.Decimal(10, 2)   // Kosten pro Lead (CPL)
  createdAt   DateTime @default(now())
  
  campaign    Campaign @relation(fields: [campaignId], references: [id])
  appointment Appointment?
  
  @@map("leads")
}

model Appointment {
  id          String   @id @default(cuid())
  leadId      String   @unique
  closerId    String
  scheduledAt DateTime
  status      AppointmentStatus @default(SCHEDULED)
  noShowReason String? // Freitext bei NO_SHOW_OTHER
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Show-Up Rate Tracking
  showedUp    Boolean  @default(false)
  callDuration Int?    // in Minuten
  
  lead        Lead     @relation(fields: [leadId], references: [id])
  closer      User     @relation(fields: [closerId], references: [id])
  deal        Deal?
  
  @@map("appointments")
}

model Deal {
  id              String   @id @default(cuid())
  appointmentId   String   @unique
  closerId        String
  status          DealStatus @default(PENDING)
  productPrice    Decimal  @db.Decimal(10, 2)
  paymentType     PaymentType
  
  // Einmalzahlung
  fullAmount      Decimal? @db.Decimal(10, 2)
  
  // Ratenzahlung
  downPayment     Decimal? @db.Decimal(10, 2)
  monthlyRate     Decimal? @db.Decimal(10, 2)
  numberOfRates   Int?
  
  // Automatische Berechnungen
  totalValue      Decimal  @db.Decimal(12, 2) // Gesamtvolumen
  paidAmount      Decimal? @db.Decimal(10, 2) // Bereits gezahlt
  
  // Tracking
  closedAt        DateTime?
  lostReason      String?  // Freitext bei LOST_OTHER
  followUpDate    DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  appointment     Appointment @relation(fields: [appointmentId], references: [id])
  closer          User     @relation(fields: [closerId], references: [id])
  payments        Payment[]
  
  @@map("deals")
}

model Payment {
  id          String   @id @default(cuid())
  dealId      String
  amount      Decimal  @db.Decimal(10, 2)
  paidAt      DateTime
  method      String?
  note        String?
  
  deal        Deal     @relation(fields: [dealId], references: [id])
  
  @@map("payments")
}

enum Role {
  ADMIN
  CLOSER
  MANAGER
}

enum CampaignStatus {
  ACTIVE
  PAUSED
  COMPLETED
}

enum AppointmentStatus {
  SCHEDULED
  COMPLETED
  NO_SHOW_FORGOT
  NO_SHOW_SICK
  NO_SHOW_GHOSTING
  NO_SHOW_OTHER
  CANCELLED
}

enum DealStatus {
  PENDING
  WON
  LOST_TOO_EXPENSIVE
  LOST_NO_NEED
  LOST_COMPETITOR
  LOST_OTHER
  FOLLOW_UP
}

enum PaymentType {
  PAYMENT_FULL
  PAYMENT_INSTALLMENTS
}

// Admin Dashboard - Tägliche Stats
model DailyStats {
  id          String   @id @default(cuid())
  date        DateTime @unique
  totalLeads  Int      @default(0)
  totalCalls  Int      @default(0)
  totalWins   Int      @default(0)
  totalRevenue Decimal @db.Decimal(12, 2) @default(0)
  showUpRate  Float    @default(0) // in Prozent
  conversionRate Float @default(0) // in Prozent
  createdAt   DateTime @default(now())
  
  @@map("daily_stats")
}